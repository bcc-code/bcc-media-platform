version: '3.8'

services:
    db:
        command: ["postgres", "-c", "log_statement=all"]
        image: postgres:13
        ports:
            - "5400:5432/tcp"
        environment:
            - POSTGRES_USER=btv
            - POSTGRES_HOST_AUTH_METHOD=trust
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U btv"]
            interval: 1s
            timeout: 5s
            retries: 5
    redis:
        image: redis
    api:
        depends_on:
            db:
                condition: service_healthy
        build:
            context: ../..
            dockerfile: ./tests/e2e/api.Dockerfile
        ports:
            - "7077:8077/tcp"
        environment:
            - ENVIRONMENT=development
            - DB_CONNECTION_STRING=postgres://btv@db/btv?sslmode=disable
            - REDIS_ADDRESS=redis:6379
            - PORT=8077
    directus:
        depends_on:
            db:
                condition: service_healthy
        build:
            context: ../../cms
        ports:
            - "7055:8055/tcp"